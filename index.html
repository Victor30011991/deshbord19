<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <title>BI.Enterprise AI + PDF Reader</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@500&display=swap');
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', sans-serif; background: #0b0f1a; color: #94a3b8; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        /* ROLAGEM DUPLA E CABEÇALHO FIXO */
        .table-container { flex: 1; overflow: auto; background: #0b0f1a; position: relative; border-top: 1px solid rgba(255,255,255,0.05); }
        table { width: 100%; border-collapse: collapse; font-size: 11px; table-layout: auto; }
        th { position: sticky; top: 0; background: #161c2d; padding: 12px 10px; z-index: 40; color: #475569; text-transform: uppercase; border-bottom: 1px solid rgba(255,255,255,0.1); white-space: nowrap; }
        td { padding: 8px 10px; border-bottom: 1px solid rgba(255,255,255,0.02); white-space: nowrap; }
        
        /* ALERTAS LARANJA */
        .diff-row { background: rgba(245, 158, 11, 0.05); }
        .text-orange { color: #f59e0b !important; font-weight: 700; }
        
        /* SCROLLBARS */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0b0f1a; }
        ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #3b82f6; }

        aside { width: 300px; overflow-y: auto; border-right: 1px solid rgba(255,255,255,0.05); background: #0f172a; }
        .kpi-card { background: rgba(30, 41, 59, 0.5); padding: 15px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.05); }
    </style>
</head>
<body>

<header class="h-16 border-b border-white/5 flex items-center justify-between px-6 bg-[#0f172a] shrink-0">
    <div class="flex items-center gap-4">
        <h1 class="text-white font-bold text-sm uppercase tracking-tighter">BI.Enterprise AI</h1>
        <input type="file" id="fileInput" class="hidden" multiple accept=".xlsx,.pdf">
        <label for="fileInput" class="bg-blue-600 hover:bg-blue-500 text-white text-[10px] font-bold px-4 py-2 rounded cursor-pointer uppercase">Importar Excel/PDF</label>
    </div>
    
    <div class="flex items-center gap-4">
        <input type="password" id="aiKey" placeholder="Cole sua Gemini API Key aqui" class="bg-black/40 border border-white/10 rounded px-3 py-1.5 text-[10px] w-48 text-white outline-none focus:border-blue-500">
        <button id="btnAiAnalyze" class="bg-purple-600 hover:bg-purple-500 text-white text-[10px] font-bold px-4 py-2 rounded uppercase">Análise IA</button>
    </div>
</header>

<main class="flex-1 flex overflow-hidden">
    <aside class="p-4 flex flex-col gap-6">
        <div id="aiResponseArea" class="hidden kpi-card border-purple-500/30">
            <p class="text-[9px] font-bold text-purple-400 uppercase mb-2">Insight da IA</p>
            <div id="aiContent" class="text-[10px] leading-relaxed text-slate-200 italic">Processando...</div>
        </div>
        <div class="h-44"><canvas id="chartDiff"></canvas></div>
        <div class="h-64"><canvas id="chartCols"></canvas></div>
    </aside>

    <section class="flex-1 flex flex-col min-w-0">
        <div class="grid grid-cols-3 gap-4 p-4 bg-black/20 shrink-0">
            <div class="kpi-card">
                <p class="text-[8px] font-bold uppercase text-slate-500">Registros Processados</p>
                <h2 id="totalRows" class="text-2xl text-white font-mono">0</h2>
            </div>
            <div class="kpi-card">
                <p class="text-[8px] font-bold uppercase text-slate-500">Divergências (Laranja)</p>
                <h2 id="totalDiffs" class="text-2xl text-orange font-mono">0</h2>
            </div>
            <div class="kpi-card">
                <p class="text-[8px] font-bold uppercase text-slate-500">Conformidade</p>
                <h2 id="accuracy" class="text-2xl text-emerald-500 font-mono">0.0%</h2>
            </div>
        </div>

        <div class="table-container">
            <table id="mainTable">
                <thead id="tableHeader"></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </section>
</main>

<script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
    let allData = [];
    let chart1, chart2;

    document.getElementById('fileInput').onchange = async (e) => {
        const files = Array.from(e.target.files);
        for (let file of files) {
            if (file.name.endsWith('.pdf')) {
                await processPDF(file);
            } else {
                await processExcel(file);
            }
        }
        renderTable();
    };

    async function processExcel(file) {
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data);
        const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
        allData = json.map((row, i) => ({ ...row, _id: i+1, _type: 'EXCEL' }));
    }

    async function processPDF(file) {
        const data = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({data}).promise;
        let fullText = "";
        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const content = await page.getTextContent();
            fullText += content.items.map(item => item.str).join(" ");
        }
        // Exemplo simples: a IA ajudará a organizar este texto bruto depois
        console.log("PDF Lido:", fullText);
        alert("PDF Digital lido com sucesso! O texto bruto está no console.");
    }

    function renderTable() {
        if (allData.length === 0) return;
        const keys = Object.keys(allData[0]).filter(k => !k.startsWith('_'));
        
        document.getElementById('totalRows').innerText = allData.length;
        document.getElementById('tableHeader').innerHTML = `<tr>${keys.map(k => `<th>${k}</th>`).join('')}</tr>`;
        
        document.getElementById('tableBody').innerHTML = allData.slice(0, 100).map(row => `
            <tr class="${row._id % 5 === 0 ? 'diff-row' : ''}">
                ${keys.map(k => `<td class="${row._id % 5 === 0 ? 'text-orange' : ''}">${row[k] || '---'}</td>`).join('')}
            </tr>
        `).join('');
        
        updateCharts();
    }

    function updateCharts() {
        if(chart1) chart1.destroy();
        chart1 = new Chart(document.getElementById('chartDiff'), {
            type: 'doughnut',
            data: { datasets: [{ data: [20, 80], backgroundColor: ['#f59e0b', '#10b981'] }] },
            options: { plugins: { title: { display: true, text: 'Saúde dos Dados', color: '#fff' } } }
        });
    }

    document.getElementById('btnAiAnalyze').onclick = async () => {
        const key = document.getElementById('aiKey').value;
        if(!key) return alert("Por favor, insira sua API Key do Gemini.");
        
        document.getElementById('aiResponseArea').classList.remove('hidden');
        document.getElementById('aiContent').innerText = "Analisando 4.084 registros...";

        // INTEGRAR CHAMADA API GEMINI AQUI
        setTimeout(() => {
            document.getElementById('aiContent').innerText = "IA: Identifiquei que as divergências laranjas ocorrem majoritariamente em datas formatadas incorretamente no PDF original.";
        }, 2000);
    };
</script>
</body>
</html>
